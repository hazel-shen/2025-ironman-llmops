# Day09 - 向量化 (Vectorization) 與 索引 (Indexing) Demo

本日目標：  
把文件片段轉換成 **向量 (Embedding)**，並透過 **索引 (Index)** 來進行語意檢索。  
這是建構 RAG Pipeline 的關鍵步驟。

---

## 📂 專案結構

```
day09_vectorize_and_index/
├── 01_embed_quickcheck.py         # 基本向量化：快速確認 Embedding 維度
├── 02_faiss_minimal_flat.py       # 最小可行 Demo：少量文件 + Flat Index 檢索
├── 02b_faiss_flat_batch.py        # 批次版本：較多文件，展示 batch embedding
├── 03_search_compare_l2_cosine.py # 完整版本：支援 L2 距離與 Cosine 相似度比較
├── README.md
└── environment.yaml               # Conda 環境設定檔
```

---

## ⚙️ 環境安裝

建立 conda 環境：

```bash
conda env create -f environment.yaml
conda activate day09_vectorize_and_index
```

`.env` 需包含：

```bash
echo "OPENAI_API_KEY=sk-xxxxxx" > .env
```

---

## 📘 Demo 說明

### 1️⃣ 01_embed_quickcheck.py

- **目的**：展示如何使用 OpenAI API 把一段文字轉換成向量。
- **輸出**：印出向量維度（例如 1536 維）。
- **重點**：理解「Embedding」是把語意轉換成數字。

**執行**：

```bash
python 01_embed_quickcheck.py
```

### 2️⃣ 02_faiss_minimal_flat.py

- **目的**：示範如何將少量文件向量化，並用 Flat Index (暴力搜尋) 來檢索。
- **內容**：
  - 文件清單（加班 / 出差 / 報銷規則）。
  - 查詢 "我要報銷 2000 元"。
  - 額外比較「加班 vs 報銷」「加班 vs 出差」的距離 → 幫助理解語意相似度。
- **重點**：
  - 教學取向，讓讀者直觀理解「語意距離」的概念。
  - 但這不是實務的檢索方式。

**執行**：

```bash
python 02_faiss_minimal_flat.py
```

**範例輸出**：

```bash
【文件清單】
00: 加班申請需事先提出，加班工時可折換補休
01: 出差申請需填寫出差單，並附上行程與預算
...
...

正在產生文件向量（embedding）...
Embedding 維度：1536（模型：text-embedding-3-small）
第一個文件向量前 8 維： [-0.0004  0.0519  0.0299  0.0002 -0.029  -0.001   0.004   0.0532]

════════════════════════════════════════════════════════════
【查詢】我要報銷 2000 元
【Top 5 結果｜距離越小越相關】
────────────────────────────────────────────────────────────
 1. 距離=0.9170 | #02 | 報銷規則需要提供發票，金額超過 1000 需經理簽核
 2. 距離=1.2500 | #09 | 飲料與零食可由團隊經費報支
 3. 距離=1.2730 | #06 | 離職需提前一個月提出申請
 4. 距離=1.3131 | #04 | 差旅住宿費上限為每晚 3000 元
 5. 距離=1.3954 | #11 | 資料庫備份需至少保存 90 天
════════════════════════════════════════════════════════════

✅ 驗證：FAISS 與 Naive(L2) 排序一致。
```

### 3️⃣ 03_search_compare_l2_cosine.py

- **目的**：模擬更貼近實務的檢索流程。
- **內容**：
  - 把 Query 向量和 所有文件向量 一次比對。
  - 支援 L2 距離與 Cosine 相似度。
  - 輸出 Top-K 檢索結果。
- **重點**：
  - 與生產環境更接近。
  - 可以快速切換不同相似度衡量方式。

**執行**：

```bash
python 03_search_compare_l2_cosine.py
```

**範例輸出**：

```bash
【文件總數】12
000: 加班申請需事先提出，加班工時可折換補休
...
...

正在產生文件向量（embedding）...
Embedding 維度：1536（模型：text-embedding-3-small）

══════════════════════════════════════════════════════════════════════
【Naive L2】Top 5（距離越小越相似）
──────────────────────────────────────────────────────────────────────
 1. dist=0.9569 | #002 | 報銷規則需要提供發票，金額超過 1000 需經理簽核
...
...
══════════════════════════════════════════════════════════════════════

══════════════════════════════════════════════════════════════════════
【FAISS L2】Top 5（距離越小越相似）
...
...
══════════════════════════════════════════════════════════════════════

══════════════════════════════════════════════════════════════════════
【Naive Cosine】Top 5（分數越大越相似）
──────────────────────────────────────────────────────────────────────
...
...
══════════════════════════════════════════════════════════════════════

══════════════════════════════════════════════════════════════════════
【FAISS Cosine (IP)】Top 5（分數越大越相似）
─────────────────────────────────────────────────────────────────────
...
...
══════════════════════════════════════════════════════════════════════

一致性檢查：
- Naive L2 vs FAISS L2：一致 ✅
- Naive Cosine vs FAISS Cosine：一致 ✅
- L2 Top-5 vs Cosine Top-5（Naive）重疊數量：5

```

---

## 📝 小結

- **01**：最小的向量化示範，認識 Embedding。
- **02**：教學取向，額外比較語意距離，幫助理解。
- **03**：實務取向，Query vs 全部文件排序，支援 L2 與 Cosine。

這三個 Demo 從基礎到完整，逐步帶你了解 **Embedding** → **Indexing** → **Retrieval** 的流程。
